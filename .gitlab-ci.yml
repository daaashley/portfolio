include:
- template: Terraform/Base.gitlab-ci.yml    # https://gitlab.com/gitlab-org/gitlab/blob/master/lib/gitlab/ci/templates/Terraform/Base.gitlab-ci.yml
- template: Jobs/SAST-IaC.gitlab-ci.yml     # https://gitlab.com/gitlab-org/gitlab/blob/master/lib/gitlab/ci/templates/Jobs/SAST-IaC.gitlab-ci.yml

stages:
- validate
- test
- pytest
- build
- deploy
- cleanup

fmt:
  extends: .terraform:fmt
  needs: []

validate:
  extends: .terraform:validate
  needs: []

build:
  extends: .terraform:build

deploy:
  extends: .terraform:deploy
  dependencies:
  - build
  environment:
    name: $TF_STATE_NAME




# Test template
.test-template:
  stage: pytest
  image: python:3.9.6-slim-buster
  except:
  - tags
  before_script:
  - apt-get update
  - apt-get -y install libpq-dev python3-dev curl build-essential procps unzip libffi-dev gcc postgresql postgresql-client
  - pip install poetry==1.2.2
  - poetry config virtualenvs.create false
  - poetry install

black:
  extends:
  - .test-template
  script:
  - black --check .


pytest:
  extends:
  - .test-template
  services:
  - name: postgres:13.8-bullseye
    alias: database
  variables:
    # Postgresql variables
    POSTGRES_HOST: db
    POSTGRES_PASSWORD: postgres
    POSTGRES_USER: postgres
    POSTGRES_DB: postgres
    POSTGRES_PORT: '5432'
  script:
  - set -x
  - apt-get --allow-releaseinfo-change update
  - apt-get install --no-install-recommends -y build-essential libpq-dev libffi-dev gcc
  - pip install --upgrade pip
  - poetry config virtualenvs.in-project true
  - poetry install
  # - apt install -y wait-for-it
  # - psql "postgresql://postgres:postgres@postgres:5432/postgres"
  #- wait-for-it -t 180 $BACKEND_DB_HOST:5432
  - poetry run pytest --cov-report term-missing --cov=src backend/tests --junitxml=report.xml
  - coverage xml
  artifacts:
    when: always
    reports:
      junit: report.xml
